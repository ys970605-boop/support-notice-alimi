<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K-Food Conquest | ì „êµ­ ëª…ë¬¼ ì •ë³µê¸°</title>
    
    <!-- ì¹´í†¡/ê³µìœ  ì‹œ ë¯¸ë¦¬ë³´ê¸° ì„¤ì • (Open Graph) -->
    <meta property="og:title" content="K-Food Conquest: ì „êµ­ ë§›ì§‘ ì˜í†  ì „ìŸ" />
    <meta property="og:description" content="ì „êµ­ ê°ì§€ì˜ ëª…ë¬¼ ë§›ì§‘ì— ë‚´ ì¡°êµ­ì˜ ê¹ƒë°œì„ ê½‚ìœ¼ì„¸ìš”! ì‹¤ì‹œê°„ ë­í‚¹ ì „ìŸ" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://ys970605-boop.github.io/support-notice-alimi/" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --china: #ff4d4f; --taiwan: #1890ff; --japan: #ffffff; --korea: #52c41a;
            --dark: #0f172a; --gold: #fbbf24; --accent: #f43f5e;
        }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Pretendard', sans-serif; background: var(--dark); overflow: hidden; color: white; }
        
        /* ë­í‚¹ ë° ì§€íœ˜ë¶€ ë³´ë“œ */
        #ranking-board {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); border: 2px solid #334155;
            border-radius: 12px; padding: 12px; width: 220px; pointer-events: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .rank-title { font-size: 10px; color: #94a3b8; letter-spacing: 1px; margin-bottom: 8px; }
        .rank-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; font-weight: 900; }
        .command-hierarchy { border-top: 1px solid #334155; margin-top: 10px; padding-top: 10px; }
        .commander-item { font-size: 11px; display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .commander-item.gold { color: var(--gold); }
        .commander-item.silver { color: #cbd5e1; }

        /* ìƒë‹¨ ì „í™©íŒ */
        #scoreboard {
            position: absolute; top: 10px; left: 250px; right: 10px; z-index: 1000;
            background: rgba(15, 23, 42, 0.9); border: 2px solid #334155;
            border-radius: 15px; padding: 12px; display: flex; justify-content: space-around;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        @media (max-width: 600px) { #scoreboard { left: 10px; top: 180px; } }
        .score-item { text-align: center; }
        .score-item .flag { font-size: 24px; display: block; }
        .score-item .val { font-weight: 900; font-size: 16px; color: var(--gold); }

        /* ê¸´ê¸‰ ë¯¸ì…˜ ì•Œë¦¼ */
        #mission-alert {
            position: absolute; top: 90px; left: 50%; transform: translateX(-50%); z-index: 1000;
            background: var(--accent); color: white; padding: 8px 20px; border-radius: 30px;
            font-size: 13px; font-weight: bold; box-shadow: 0 4px 15px rgba(244,63,94,0.4);
            animation: slideDown 0.5s ease-out, pulse 1.5s infinite;
            display: none; white-space: nowrap;
        }
        @keyframes slideDown { from { top: -50px; } to { top: 90px; } }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* ì§€ê°‘ */
        #wallet {
            position: absolute; top: 140px; right: 15px; z-index: 1000;
            background: #10b981; color: white; padding: 8px 15px; border-radius: 12px;
            font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid #34d399;
        }

        #map { width: 100%; height: 100%; z-index: 1; transition: filter 0.5s; }

        /* ë°”í…€ ì‹œíŠ¸ */
        #capture-panel {
            position: absolute; bottom: -100%; left: 0; right: 0; z-index: 2000;
            background: #ffffff; border-top: 6px solid var(--gold); border-radius: 30px 30px 0 0;
            padding: 25px; transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 -15px 50px rgba(0,0,0,0.2);
            color: #1e293b; max-height: 85vh; overflow-y: auto;
        }
        #capture-panel.open { bottom: 0; }
        
        /* ì»¤ìŠ¤í…€ í•€ ìŠ¤íƒ€ì¼ */
        .marker-pin {
            width: 45px; height: 45px; border-radius: 50% 50% 50% 0; background: white;
            position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -22px 0 0 -22px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 2px solid #334155;
        }
        .marker-pin span { transform: rotate(45deg); font-size: 24px; }
        .marker-pin.bounty { background: var(--gold); border-color: white; animation: pulseGold 1s infinite; }
        .marker-pin.top-rank::after {
            content: 'ğŸ‘‘'; position: absolute; top: -25px; left: 5px; transform: rotate(45deg);
            font-size: 25px; filter: drop-shadow(0 0 5px gold); animation: float 1s infinite alternate;
        }
        @keyframes float { from { top: -25px; } to { top: -35px; } }
        @keyframes pulseGold { 0% { box-shadow: 0 0 0 0 rgba(251,191,36,0.7); } 70% { box-shadow: 0 0 0 15px rgba(251,191,36,0); } 100% { box-shadow: 0 0 0 0 rgba(251,191,36,0); } }

        /* ìŒì‹ ì‚¬ì§„ ìŠ¤íƒ€ì¼ */
        .res-photo {
            width: 100%; height: 180px; border-radius: 15px; object-fit: cover;
            margin-bottom: 15px; border: 2px solid #eee;
        }
        .bounty-badge { background: var(--gold); color: #000; padding: 4px 10px; border-radius: 5px; font-weight: 900; font-size: 12px; margin-bottom: 10px; display: inline-block; }
        .res-name { font-size: 24px; font-weight: 900; margin: 0; color: #0f172a; line-height: 1.2; }
        .owner-msg { font-style: italic; color: #64748b; margin: 10px 0; font-size: 14px; border-left: 3px solid var(--gold); padding-left: 10px; }

        .btn-capture {
            width: 100%; padding: 18px; border: none; border-radius: 15px;
            background: var(--gold); color: #000; font-size: 20px; font-weight: 900;
            cursor: pointer; margin-top: 20px; box-shadow: 0 5px 15px rgba(251,191,36,0.3);
        }
        .btn-capture:active { transform: scale(0.95); }

        /* ì „ìˆ  ìƒì  ë° ì±„íŒ… íŠ¸ë¦¬ê±° */
        #shop-trigger, #chat-trigger { position: absolute; z-index: 1000; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 20px; }
        #shop-trigger { top: 190px; right: 15px; background: #3b82f6; color: white; }
        #chat-trigger { top: 190px; left: 15px; background: var(--accent); color: white; }

        /* íŒì—… íŒ¨ë„ */
        .ui-panel { position: absolute; z-index: 1000; background: rgba(15, 23, 42, 0.95); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: none; overflow: hidden; cursor: move; }
        .panel-header { background: rgba(255,255,255,0.05); padding: 8px 12px; font-size: 10px; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
        #shop-panel { top: 240px; right: 15px; width: 180px; border: 1px solid #3b82f6; }
        #chat-panel { top: 240px; left: 15px; width: 220px; height: 350px; flex-direction: column; border: 1px solid var(--accent); }
        #wallet { top: 140px; right: 15px; border: 1px solid #34d399; }
        #music-player { bottom: 85px; left: 15px; border: 1px solid var(--gold); border-radius: 20px; }

        /* AI ìŠ¤ìº” ì˜¤ë²„ë ˆì´ */
        #scan-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; color: #00ff00; font-family: monospace; }
        @keyframes scanAnim { from { top: 0; } to { top: 350px; } }
    </style>
</head>
<body>

    <div id="ranking-board" class="ui-panel" style="display:block;">
        <div class="panel-header">ğŸ›°ï¸ SYSTEM STATUS <span>:::</span></div>
        <div style="padding: 12px;">
            <div class="rank-title">NATION RANKING & COMMAND</div>
            <div id="ranks">
                <div class="rank-row"><span>ğŸ‡¨ğŸ‡³ ì¤‘êµ­</span><span>42%</span></div>
                <div class="rank-row" style="color:var(--gold)"><span>ğŸ‡°ğŸ‡· í•œêµ­</span><span>28%</span></div>
                <div class="rank-row"><span>ğŸ‡¯ğŸ‡µ ì¼ë³¸</span><span>30%</span></div>
            </div>
            <div class="command-hierarchy">
                <div class="rank-title">ğŸ‡°ğŸ‡· í•œêµ­ ì§€íœ˜ë¶€</div>
                <div class="commander-item gold">â­ ì‚¬ë ¹ê´€: ë¯¸ì‹ëŒ€ì¥</div>
                <div class="commander-item silver">ğŸ–ï¸ ë¶€ì‚¬ë ¹ê´€: ì„±ìˆ˜ì •ë³µì</div>
            </div>
        </div>
    </div>

    <div id="scoreboard">
        <div class="score-item"><span class="flag">ğŸ‡¨ğŸ‡³</span><span class="val">42%</span></div>
        <div class="score-item" style="border-left: 1px solid #334155; border-right: 1px solid #334155; padding: 0 30px;"><span class="flag">ğŸ‡°ğŸ‡·</span><span class="val">28%</span></div>
        <div class="score-item"><span class="flag">ğŸ‡¯ğŸ‡µ</span><span class="val">30%</span></div>
    </div>

    <div id="mission-alert">ğŸš¨ ê¸´ê¸‰ íƒˆí™˜ í˜„ìƒê¸ˆ ë°œìƒ!</div>

    <div id="wallet" class="ui-panel" style="display:block;">
        <div class="panel-header">ğŸ’³ WALLET <span>:::</span></div>
        <div style="padding: 10px 15px; font-weight: bold; color:#10b981;">â‚© <span id="cash-val">1,500</span></div>
    </div>

    <div id="shop-trigger" onclick="toggleShop()">ğŸ›’</div>
    <div id="chat-trigger" onclick="toggleChat()">ğŸ’¬</div>

    <div id="shop-panel" class="ui-panel">
        <div class="panel-header">ğŸ›’ TACTICAL SHOP <span>:::</span></div>
        <div style="padding: 15px;">
            <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 12px; font-weight: bold;">â„ï¸ ì–¼ìŒ í­í’</div>
                <div style="font-size: 10px; color: #94a3b8;">10ë¶„ê°„ íƒ€êµ­ ë§ˆë¹„</div>
                <button onclick="buyItem('freeze')" style="width: 100%; margin-top: 5px; background: #3b82f6; color: white; border: none; border-radius: 4px; padding: 5px; font-size: 11px; cursor: pointer;">â‚© 2,000 êµ¬ë§¤</button>
            </div>
            <button onclick="shareKakao()" style="width: 100%; background: #fee500; color: #3c1e1e; border: none; border-radius: 8px; padding: 10px; font-weight: bold; font-size: 12px; cursor: pointer;">ğŸ¤ ì§€ì›êµ° ìš”ì²­í•˜ê¸°</button>
        </div>
    </div>

    <div id="chat-panel" class="ui-panel">
        <div class="panel-header">ğŸ’¬ WAR ROOM <span>:::</span></div>
        <div style="padding: 15px; display: flex; flex-direction: column; height: 300px;">
            <b style="font-size: 14px; color: var(--accent); margin-bottom: 10px; display: block;">ğŸ‡°ğŸ‡· í•œêµ­êµ° ë¹„ë°€ ì „ëµì‹¤</b>
            <div id="commander-menu" style="background: rgba(244,63,94,0.1); border: 1px dashed var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 10px;">
                <div style="font-size: 10px; color: var(--accent); font-weight: bold; margin-bottom: 5px;">ğŸ–ï¸ ì‚¬ë ¹ê´€ ì „ìš©: ì‘ì „ ë°œë ¹</div>
                <select id="bounty-target" style="width: 100%; font-size: 10px; background: #1e293b; color: white; border: 1px solid #334155; margin-bottom: 5px;">
                    <option value="">íƒ€ê²Ÿ ì„ íƒ...</option>
                    <option value="1">ì„±ìˆ˜ì¡±ë°œ</option>
                    <option value="5">ì´ì¬ëª¨í”¼ì</option>
                    <option value="6">ì„±ì‹¬ë‹¹</option>
                    <option value="7">ì—°ëˆ</option>
                </select>
                <div style="display: flex; gap: 3px;">
                    <input type="number" id="bounty-amount" placeholder="â‚©" style="width: 60%; font-size: 10px; background: #1e293b; color: white; border: 1px solid #334155;">
                    <button onclick="setCommanderBounty()" style="flex-grow: 1; font-size: 9px; background: var(--accent); color: white; border: none; border-radius: 3px; cursor: pointer;">ë°œë ¹</button>
                </div>
            </div>
            <div id="chat-messages" style="flex-grow: 1; overflow-y: auto; font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 10px; color:white;">
                <div style="color: #94a3b8;">[ì‹œìŠ¤í…œ] ì „ìš°ë“¤ê³¼ ì „ëµì„ ê³µìœ í•˜ì„¸ìš”.</div>
            </div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€..." style="flex-grow: 1; background: #1e293b; border: 1px solid #334155; color: white; padding: 5px; border-radius: 4px; font-size: 11px;">
                <button onclick="sendChatMessage()" style="background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div id="scan-overlay">
        <div style="width: 250px; height: 350px; border: 2px solid #00ff00; position: relative; overflow: hidden; margin-bottom: 20px;">
            <div id="scan-line" style="position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #00ff00; box-shadow: 0 0 15px #00ff00; animation: scanAnim 2s infinite;"></div>
            <div id="scan-logs" style="padding: 10px; font-size: 10px; color: #00ff00;"></div>
        </div>
        <b style="font-size: 18px; letter-spacing: 2px;">AI RECEIPT ANALYZING...</b>
        <div id="scan-progress" style="width: 200px; height: 4px; background: #111; margin-top: 15px; border-radius: 2px; overflow: hidden;"><div id="scan-bar" style="width: 0%; height: 100%; background: #00ff00; transition: width 0.1s;"></div></div>
    </div>

    <div id="music-player" class="ui-panel" style="display:flex;">
        <div class="panel-header">ğŸµ ANTHEM <span>:::</span></div>
        <div style="padding: 8px 15px; display: flex; align-items: center; gap: 10px;">
            <marquee id="music-title" style="width: 80px; font-size: 10px; color: var(--gold);">í˜„ì¬ 1ìœ„ êµ­ê°€ ì—°ì£¼ ì¤‘...</marquee>
            <button onclick="toggleMusic()" style="background: none; border: none; color: white; cursor: pointer;">â¸</button>
        </div>
    </div>

    <audio id="anthem-audio" loop></audio>
    <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleCameraCapture(this)">

    <div id="map"></div>

    <div id="capture-panel">
        <img id="p-photo" class="res-photo" src="" alt="ìŒì‹">
        <div id="bounty-info" class="bounty-badge">ğŸ’° íŠ¹ë³„ í˜„ìƒê¸ˆ ë°œë ¹</div>
        <h2 id="p-name" class="res-name">ì‹ë‹¹ ì´ë¦„</h2>
        <p id="p-owner-msg" class="owner-msg"></p>
        <div id="p-details"></div>
        <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-top: 15px;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 5px;">í˜„ì¬ ì ìœ  êµ­ê°€</div>
            <div id="p-current-owner" style="font-size: 18px; font-weight: bold; color:#0f172a;">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ ì‚¬ë ¹ë¶€</div>
        </div>
        <button class="btn-capture" onclick="triggerCamera()">ğŸš© íƒˆí™˜ ì‘ì „ ê°œì‹œ (ì¹´ë©”ë¼ ì´¬ì˜)</button>
    </div>

    <script>
        // --- 1. ì „ì—­ ìƒíƒœ ë° ì§€ë„ ì´ˆê¸°í™” ---
        let myCash = 1500;
        let topNation = "ğŸ‡¨ğŸ‡³";
        let isFrozen = false;
        let selectedSpot = null;
        let userMarker = null;
        const markers = {};
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([36.2, 127.8], 7);

        // ì‹œê°„ëŒ€ë³„ í…Œë§ˆ ì „í™˜
        const isNight = new Date().getHours() >= 19 || new Date().getHours() < 7;
        L.tileLayer(isNight ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

        // --- 2. ë°ì´í„° ì„¸íŒ… (ì „êµ­ TOP 5) ---
        const spots = [
            { id: 1, name: "ì„±ìˆ˜ì¡±ë°œ", lat: 37.5446, lng: 127.0565, owner: "ğŸ‡¨ğŸ‡³", bounty: 1000, rank: 1, region: "ì„œìš¸", img: "https://images.unsplash.com/photo-1628253747716-0c4f5c90f75c?auto=format&fit=crop&w=400&q=80", addr: "ì„œìš¸ ì„±ë™êµ¬ ì•„ì°¨ì‚°ë¡œ7ê¸¸ 7", menu: "ì„±ìˆ˜ì¡±ë°œ(ëŒ€) 45,000ì›", info: "ğŸ…¿ï¸ ì£¼ì°¨ ë¶ˆê°€ | ğŸ•’ 12:00 ~ 22:00", tip: "ì„œìš¸ 3ëŒ€ ì¡±ë°œ! í¬ì¥ì´ ë¹ ë¦…ë‹ˆë‹¤." },
            { id: 5, name: "ì´ì¬ëª¨í”¼ì ë³¸ì ", lat: 35.1021, lng: 129.0315, owner: "ğŸ‡¯ğŸ‡µ", bounty: 2000, rank: 1, region: "ë¶€ì‚°", img: "https://images.unsplash.com/photo-1513104890138-7c749659a591?auto=format&fit=crop&w=400&q=80", addr: "ë¶€ì‚° ì¤‘êµ¬ ê´‘ë³µì¤‘ì•™ë¡œ 31", menu: "ì´ì¬ëª¨ í¬ëŸ¬ìŠ¤íŠ¸ 25,000ì›", info: "ğŸ…¿ï¸ ì¸ê·¼ ì£¼ì°¨ | ğŸ•’ 11:00 ~ 21:00", tip: "ì¹˜ì¦ˆ í’ë¯¸ê°€ ì˜ˆìˆ ì…ë‹ˆë‹¤." },
            { id: 6, name: "ì„±ì‹¬ë‹¹ ë³¸ì ", lat: 36.3277, lng: 127.4273, owner: "ğŸ‡¨ğŸ‡³", bounty: 3000, rank: 1, region: "ëŒ€ì „", img: "https://images.unsplash.com/photo-1509440159596-0249088772ff?auto=format&fit=crop&w=400&q=80", addr: "ëŒ€ì „ ì¤‘êµ¬ ëŒ€ì¢…ë¡œ480ë²ˆê¸¸ 15", menu: "íŠ€ê¹€ì†Œë³´ë¡œ 1,700ì›", info: "ğŸ…¿ï¸ ì£¼ì°¨ ê°€ëŠ¥ | ğŸ•’ 08:00 ~ 22:00", tip: "ëª…ë€ë°”ê²ŒíŠ¸ ì¶”ì²œ!" },
            { id: 7, name: "ì—°ëˆ", lat: 33.2492, lng: 126.4075, owner: "ğŸ‡°ğŸ‡·", bounty: 0, rank: 1, region: "ì œì£¼", img: "https://images.unsplash.com/photo-1594179047519-f347310d3322?auto=format&fit=crop&w=400&q=80", addr: "ì œì£¼ì‹œ ì¼ì£¼ì„œë¡œ 968-10", menu: "ì¹˜ì¦ˆê¹ŒìŠ¤ 13,000ì›", info: "ğŸ…¿ï¸ ì£¼ì°¨ ê°€ëŠ¥ | ğŸ•’ 12:00 ~ 21:00", tip: "ìºì¹˜í…Œì´ë¸” ì˜ˆì•½ í•„ìˆ˜!" }
        ];

        // --- 3. í•µì‹¬ ê¸°ëŠ¥ í•¨ìˆ˜ ---
        function triggerVibration(pattern) { if ("vibrate" in navigator) navigator.vibrate(pattern); }

        function startGPSTracking() {
            if (!navigator.geolocation) return;
            navigator.geolocation.watchPosition((pos) => {
                const { latitude: lat, longitude: lng } = pos.coords;
                if (!userMarker) userMarker = L.circleMarker([lat, lng], { radius: 10, color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.8 }).addTo(map);
                else userMarker.setLatLng([lat, lng]);
                spots.forEach(spot => {
                    const dist = map.distance([lat, lng], [spot.lat, spot.lng]);
                    if (dist < 100) {
                        const ab = document.getElementById('mission-alert');
                        ab.innerHTML = `ğŸ“ [${spot.name}] ê·¼ì ‘! ì¦‰ì‹œ ì ë ¹ ê°€ëŠ¥ (${Math.round(dist)}m)`;
                        ab.style.display = 'block';
                        triggerVibration([200, 100, 200]);
                        ab.onclick = () => { selectedSpot = spot; openPanel(spot); };
                    }
                });
            }, null, { enableHighAccuracy: true });
        }

        function makeDraggable(el) {
            let p1=0, p2=0, p3=0, p4=0;
            const h = el.querySelector(".panel-header") || el;
            const saved = JSON.parse(localStorage.getItem('ui_pos_' + el.id));
            if (saved) { el.style.top = saved.top; el.style.left = saved.left; el.style.bottom = 'auto'; el.style.right = 'auto'; }
            h.onmousedown = dragStart; h.ontouchstart = dragStart;
            function dragStart(e) { p3 = e.clientX || e.touches[0].clientX; p4 = e.clientY || e.touches[0].clientY; document.onmouseup = dragEnd; document.ontouchend = dragEnd; document.onmousemove = dragging; document.ontouchmove = dragEnd; }
            function dragging(e) { const cx = e.clientX || e.touches[0].clientX, cy = e.clientY || e.touches[0].clientY; p1 = p3 - cx; p2 = p4 - cy; p3 = cx; p4 = cy; el.style.top = (el.offsetTop - p2) + "px"; el.style.left = (el.offsetLeft - p1) + "px"; el.style.bottom = 'auto'; el.style.right = 'auto'; }
            function dragEnd() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; localStorage.setItem('ui_pos_' + el.id, JSON.stringify({ top: el.style.top, left: el.style.left })); }
        }

        function updateMarker(spot) {
            const isBounty = spot.bounty > 0, isTop = spot.owner === topNation;
            const icon = L.divIcon({ className: 'custom-div-icon', html: `<div class="marker-pin ${isBounty?'bounty':''} ${isTop?'top-rank':''}"> <div style="position:absolute; top:-12px; font-size:10px; font-weight:900; background:white; padding:1px 4px; border-radius:10px; border:1px solid #334155;">#${spot.rank}</div> <span>${isBounty?'ğŸ’°':spot.owner}</span></div>`, iconSize: [45, 45], iconAnchor: [22, 45] });
            if (markers[spot.id]) markers[spot.id].setIcon(icon);
            else { const m = L.marker([spot.lat, spot.lng], { icon: icon }).addTo(map); markers[spot.id] = m; m.on('click', () => { selectedSpot = spot; openPanel(spot); }); }
        }

        function openPanel(spot) {
            document.getElementById('p-name').innerHTML = `<span style="font-size:14px; color:var(--accent)">[${spot.region} 1ìœ„ ëª…ë¬¼]</span><br>${spot.name}`;
            document.getElementById('p-photo').src = spot.img;
            document.getElementById('p-owner-msg').innerText = spot.msg || "ëª…ì˜ˆë¥¼ ì§€í‚¤ì„¸ìš”!";
            document.getElementById('p-current-owner').innerText = `${spot.owner} ì‚¬ë ¹ë¶€`;
            document.getElementById('p-details').innerHTML = `<div style="margin-top:15px; font-size:13px; color:#1e293b;"><div style="background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:10px;"><b>ğŸ“ ì£¼ì†Œ:</b> ${spot.addr}</div><div><b>ğŸ´ ë©”ë‰´:</b> ${spot.menu}</div><div><b>â„¹ï¸ ì •ë³´:</b> ${spot.info}</div><div style="color:#3b82f6; font-size:12px; margin-top:5px;"><b>ğŸ’¡ íŒ:</b> ${spot.tip}</div><div style="display:flex; gap:8px; margin-top:15px;"><button onclick="goNavi('naver', '${spot.name}', ${spot.lat}, ${spot.lng})" style="flex:1; background:#03c75a; color:white; border:none; border-radius:8px; padding:10px; font-size:12px; font-weight:bold; cursor:pointer;">ë„¤ì´ë²„ ì§€ë„ ğŸš—</button><button onclick="goNavi('kakao', '${spot.name}', ${spot.lat}, ${spot.lng})" style="flex:1; background:#fae100; color:#3c1e1e; border:none; border-radius:8px; padding:10px; font-size:12px; font-weight:bold; cursor:pointer;">ì¹´ì¹´ì˜¤ ë§µ ğŸ“</button></div></div>`;
            document.getElementById('bounty-info').style.display = spot.bounty > 0 ? 'inline-block' : 'none';
            document.getElementById('capture-panel').classList.add('open');
        }

        function goNavi(s, n, lt, lg) { let u = s==='naver'?`nmap://route/car?dlat=${lt}&dlng=${lg}&dname=${encodeURIComponent(n)}` : `kakaomap://route?ep=${lt},${lg}&by=CAR`; window.location.href = u; setTimeout(() => window.open(s==='naver'?`https://map.naver.com/v5/directions/-/-/${lt},${lg},${encodeURIComponent(n)}` : `https://map.kakao.com/link/to/${encodeURIComponent(n)},${lt},${lg}`), 500); }
        function toggleShop() { const p = document.getElementById('shop-panel'); p.style.display = p.style.display === 'none' ? 'block' : 'none'; }
        function toggleChat() { const p = document.getElementById('chat-panel'); p.style.display = p.style.display === 'none' ? 'flex' : 'none'; }
        function buyItem(t) { if(myCash < 2000) { alert('ìê¸ˆ ë¶€ì¡±!'); return; } myCash -= 2000; document.getElementById('cash-val').innerText = myCash.toLocaleString(); if(t === 'freeze') { isFrozen = true; document.getElementById('map').style.filter = 'brightness(0.8) saturate(0.5) hue-rotate(180deg)'; alert('â„ï¸ ì–¼ìŒ í­í’ ë°œë™!'); setTimeout(() => { isFrozen = false; document.getElementById('map').style.filter = ''; }, 10000); } toggleShop(); }
        function shareKakao() { const t = "ğŸš¨ ê¸´ê¸‰! ì „ì¥ í•©ë¥˜ ìš”ì²­! \n https://ys970605-boop.github.io/support-notice-alimi/"; prompt("ë©”ì‹œì§€:", t); }
        function sendChatMessage() { const i = document.getElementById('chat-input'); if(!i.value) return; const m = document.getElementById('chat-messages'); const d = document.createElement('div'); d.style.marginBottom = '5px'; d.innerHTML = `<b>ë‚˜:</b> ${i.value}`; m.appendChild(d); m.scrollTop = m.scrollHeight; i.value = ''; }
        function setCommanderBounty() { const t = document.getElementById('bounty-target').value, a = parseInt(document.getElementById('bounty-amount').value); if(!t || isNaN(a)) return; if(myCash < a) { alert('ê³µê¸ˆ ë¶€ì¡±!'); return; } const s = spots.find(x => x.id == t); s.bounty = a; myCash -= a; document.getElementById('cash-val').innerText = myCash.toLocaleString(); updateMarker(s); const al = document.getElementById('mission-alert'); al.innerText = `ğŸ–ï¸ ì‘ì „: [${s.name}] â‚©${a.toLocaleString()} í˜„ìƒê¸ˆ!`; al.style.display = 'block'; setTimeout(() => al.style.display = 'none', 5000); }
        function triggerCamera() { if(isFrozen) { alert('â„ï¸ ë§ˆë¹„ ìƒíƒœ!'); return; } document.getElementById('camera-input').click(); }
        function handleCameraCapture(i) { if(i.files && i.files[0]) startCapture(); }
        async function startCapture() { if(!selectedSpot) return; document.getElementById('scan-overlay').style.display = 'flex'; const l = document.getElementById('scan-logs'), b = document.getElementById('scan-bar'); const steps = ["Initializing...", "Scanning Receipt...", "Matching Merchant: " + selectedSpot.name, "GPS Validated", "Success"]; for(let i=0; i<steps.length; i++) { const d = document.createElement('div'); d.innerText = `> ${steps[i]}`; l.appendChild(d); b.style.width = ((i+1)/steps.length*100)+'%'; await new Promise(r => setTimeout(r, 400)); } setTimeout(() => { document.getElementById('scan-overlay').style.display = 'none'; l.innerHTML = ''; const gain = 500 + selectedSpot.bounty; myCash += gain; document.getElementById('cash-val').innerText = myCash.toLocaleString(); triggerVibration([100, 50, 100, 50, 300]); alert(`ğŸ¯ ì„±ê³µ! â‚©${gain.toLocaleString()} ì§€ê¸‰.`); selectedSpot.owner = "ğŸ‡°ğŸ‡·"; selectedSpot.bounty = 0; updateMarker(selectedSpot); document.getElementById('capture-panel').classList.remove('open'); }, 500); }
        const ANTHEMS = { "ğŸ‡°ğŸ‡·": { title: "ëŒ€í•œë¯¼êµ­ - ì• êµ­ê°€", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" }, "ğŸ‡¨ğŸ‡³": { title: "ì¤‘êµ­ - ì˜ìš©êµ° ì§„í–‰ê³¡", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" }, "ğŸ‡¯ğŸ‡µ": { title: "ì¼ë³¸ - ê¸°ë¯¸ê°€ìš”", url: "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" } };
        function updateAnthem() { const a = document.getElementById('anthem-audio'), t = document.getElementById('music-title'), an = ANTHEMS[topNation] || ANTHEMS["ğŸ‡°ğŸ‡·"]; if(a.src !== an.url) { a.src = an.url; t.innerText = `1ìœ„: ${an.title}`; a.play().catch(e => {}); } }
        function toggleMusic() { const a = document.getElementById('anthem-audio'); if(a.paused) a.play(); else a.pause(); }
        
        map.on('click', () => { document.getElementById('capture-panel').classList.remove('open'); document.getElementById('shop-panel').style.display = 'none'; document.getElementById('chat-panel').style.display = 'none'; });
        document.addEventListener('DOMContentLoaded', () => { startGPSTracking(); ['ranking-board', 'shop-panel', 'chat-panel', 'wallet', 'music-player'].forEach(id => { const el = document.getElementById(id); if(el) makeDraggable(el); }); });
        setInterval(updateAnthem, 5000); spots.forEach(updateMarker);
    </script>
</body>
</html>
