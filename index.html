<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-Conquest: Global War | 지구 정복</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #0f0; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        #ranking { position: absolute; top: 20px; left: 20px; background: rgba(0,20,0,0.8); border: 1px solid #0f0; padding: 10px; border-radius: 5px; pointer-events: auto; }
        #res { position: absolute; top: 20px; right: 20px; font-size: 24px; font-weight: bold; color: #fadb14; }
        #msg { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80%; text-align: center; }
        .btn-panel { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; pointer-events: auto; }
        .btn { background: #020; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; cursor: pointer; border-radius: 5px; font-size: 12px; }
        .btn:hover { background: #040; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="ranking"><b>GLOBAL RANKING</b><div id="rank-list"></div></div>
        <div id="res">GOLD: <span id="gold-val">500</span></div>
        <div id="msg">마우스로 지구를 돌리고, 버튼을 눌러 병력을 파견하십시오.</div>
        <div class="btn-panel">
            <button class="btn" onclick="spawnOnEarth('soldier')">파병: 보병 (100G)</button>
            <button class="btn" onclick="spawnOnEarth('tank')">파병: 탱크 (300G)</button>
        </div>
    </div>

    <!-- Three.js 라이브러리 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let scene, camera, renderer, earth;
        let gold = 500;
        let units = [];
        let hqs = [];

        const TEAMS = [
            { id: 1, name: "한국", color: "#52c41a", pos: {lat: 37, lon: 127}, score: 0 },
            { id: 2, name: "미국", color: "#3f51b5", pos: {lat: 38, lon: -77}, score: 0 },
            { id: 3, name: "중국", color: "#ff4d4f", pos: {lat: 39, lon: 116}, score: 0 },
            { id: 4, name: "영국", color: "#ffffff", pos: {lat: 51, lon: 0}, score: 0 }
        ];

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 우주 배경 조명
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xffffff, 1);
            sunLight.position.set(5, 3, 5);
            scene.add(sunLight);

            // 지구 생성
            const geometry = new THREE.SphereGeometry(5, 64, 64);
            const texture = new THREE.TextureLoader().load('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg');
            const material = new THREE.MeshPhongMaterial({ map: texture, shininess: 0.5 });
            earth = new THREE.Mesh(geometry, material);
            scene.add(earth);

            // 국가별 기지(HQ) 설치
            TEAMS.forEach(team => {
                const hqPos = latLonToVector3(team.pos.lat, team.pos.lon, 5.1);
                const hqGeom = new THREE.BoxGeometry(0.3, 0.3, 0.3);
                const hqMat = new THREE.MeshPhongMaterial({ color: team.color });
                const hqMesh = new THREE.Mesh(hqGeom, hqMat);
                hqMesh.position.copy(hqPos);
                hqMesh.lookAt(new THREE.Vector3(0,0,0));
                scene.add(hqMesh);
                hqs.push({ mesh: hqMesh, team: team });
            });

            camera.position.z = 12;

            animate();
            setInterval(gameLogic, 100);
        }

        function latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            return new THREE.Vector3(
                -radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        function spawnOnEarth(type) {
            const cost = type === 'soldier' ? 100 : 300;
            if (gold < cost) return;
            gold -= cost;
            updateUI();

            const myHq = hqs.find(h => h.team.id === 1);
            const unitGeom = type === 'soldier' ? new THREE.SphereGeometry(0.1, 8, 8) : new THREE.BoxGeometry(0.2, 0.1, 0.2);
            const unitMat = new THREE.MeshPhongMaterial({ color: TEAMS[0].color });
            const unitMesh = new THREE.Mesh(unitGeom, unitMat);
            
            // 한국 본부 근처 위도/경도로 시작
            const unit = {
                mesh: unitMesh,
                teamId: 1,
                lat: 37 + (Math.random()-0.5)*5,
                lon: 127 + (Math.random()-0.5)*5,
                targetHq: hqs[Math.floor(Math.random() * (hqs.length - 1)) + 1],
                hp: 100
            };
            
            scene.add(unitMesh);
            units.push(unit);
        }

        function gameLogic() {
            // 유닛 이동 및 전투
            units.forEach((u, idx) => {
                if (!u.targetHq) return;
                
                // 적 본부를 향해 조금씩 위도/경도 이동
                const dLat = u.targetHq.team.pos.lat - u.lat;
                const dLon = u.targetHq.team.pos.lon - u.lon;
                u.lat += dLat * 0.01;
                u.lon += dLon * 0.01;

                const pos = latLonToVector3(u.lat, u.lon, 5.2);
                u.mesh.position.copy(pos);

                // 목표 도착 시 공격
                if (Math.abs(dLat) < 1 && Math.abs(dLon) < 1) {
                    u.targetHq.team.score += 10;
                    TEAMS[0].score += 5; // 점수 획득
                    // 전투 연출 후 삭제 (시뮬레이션)
                    scene.remove(u.mesh);
                    units.splice(idx, 1);
                }
            });

            // AI 파병 시뮬레이션
            if (Math.random() < 0.05) {
                const enemyTeam = TEAMS[Math.floor(Math.random()*3)+1];
                enemyTeam.score += 1;
            }

            updateRanking();
        }

        function updateRanking() {
            let html = '';
            [...TEAMS].sort((a,b) => b.score - a.score).forEach(t => {
                html += `<div style="color:${t.color}; font-size:12px;">${t.name}: ${t.score} PTS</div>`;
            });
            document.getElementById('rank-list').innerHTML = html;
        }

        function updateUI() {
            document.getElementById('gold-val').innerText = gold;
        }

        // 마우스 조작 (지구 회전)
        let isMouseDown = false, mouseX = 0, mouseY = 0;
        document.addEventListener('mousedown', e => { isMouseDown = true; });
        document.addEventListener('mouseup', () => { isMouseDown = false; });
        document.addEventListener('mousemove', e => {
            if (!isMouseDown) return;
            earth.rotation.y += (e.clientX - mouseX) * 0.005;
            earth.rotation.x += (e.clientY - mouseY) * 0.005;
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        function animate() {
            requestAnimationFrame(animate);
            // 자동 자전
            if (!isMouseDown) earth.rotation.y += 0.001;
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
