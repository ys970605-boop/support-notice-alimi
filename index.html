<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>지원공고알리미 MVP</title>
  <script src="../gov-support-hub/notices.js"></script>
  <script src="./notices.js"></script>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--line:#dce4ee;--text:#1f2d3d;--sub:#62758b;--brand:#2d7ff9}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo',sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{margin:0 0 4px;color:#16314f}
    .small{font-size:12px;color:var(--sub)}

    .stats,.profile,.filters,.todo,.cards{display:grid;gap:10px}
    .stats{grid-template-columns:1fr;margin-bottom:10px}
    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .box b{font-size:22px;color:#1d3f66}

    .profile{grid-template-columns:repeat(4,1fr) auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    .filters{grid-template-columns:1.2fr .8fr .8fr .8fr .8fr auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    .quick-filters{display:flex;flex-wrap:wrap;gap:8px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    input,select,button{padding:10px;border:1px solid #c8d5e4;border-radius:10px;background:#fff}
    button{cursor:pointer}.btn{background:var(--brand);color:#fff;border:none;font-weight:700}
    .btn-lite{background:#fff;color:#2f5b95;border:1px solid #cfe0f3;font-weight:700}
    .btn-lite.on{background:#eef4ff}

    .todo{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .todo ul{margin:8px 0 0 18px;padding:0}
    .bookbtn{font-size:12px;padding:6px 10px}

    .cards{grid-template-columns:repeat(auto-fill,minmax(330px,1fr));padding-bottom:80px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef4ff;border:1px solid #d2e1ff;color:#2f5b95;white-space:nowrap}
    .d1{background:#fff2f2;border-color:#ffcaca;color:#b42318}.d3{background:#fff8eb;border-color:#ffd9ab;color:#ad5b00}.d7{background:#f2fbf7;border-color:#c9efdf;color:#0a7a52}
    .fit-hi{background:#effcf6;border-color:#b8ebd4;color:#0a7a52}.fit-mid{background:#fff8eb;border-color:#ffd9ab;color:#ad5b00}.fit-low{background:#f4f7fb;border-color:#d7e1ed;color:#5f7186}
    .reasons{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .reason{font-size:11px;padding:2px 8px;border-radius:999px;background:#f7f9fd;border:1px solid #e1e8f2;color:#4f6479}
    a{color:#1b73e8;text-decoration:none;font-weight:600}
    .openchat-wrap{margin:0 0 10px}
    .openchat-btn{display:inline-block;background:#FEE500;color:#1f1f1f !important;border:1px solid #e8d200;padding:10px 14px;border-radius:10px;font-weight:800}
    .sticky-cta{position:fixed;left:12px;right:12px;bottom:12px;z-index:60;display:flex;justify-content:center;pointer-events:none}
    .sticky-cta a{pointer-events:auto;display:inline-block;background:#FEE500;color:#1f1f1f !important;border:1px solid #e8d200;padding:12px 18px;border-radius:999px;font-weight:900;box-shadow:0 6px 18px rgba(0,0,0,.15)}

    .modal{position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;align-items:center;justify-content:center;z-index:80;padding:20px}
    .modal.on{display:flex}
    .modal-card{width:min(780px,100%);max-height:88vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid #dfe7f2;padding:16px}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .detail-box{background:#f8fbff;border:1px solid #e4edf9;border-radius:10px;padding:10px}
    .detail-box b{display:block;margin-bottom:6px;color:#173457}

    @media (max-width:1050px){
      .stats{grid-template-columns:1fr 1fr}
      .profile{grid-template-columns:1fr 1fr 1fr}
      .filters{grid-template-columns:1fr 1fr}
    }
    @media (max-width:640px){
      .cards{grid-template-columns:1fr}
      .profile{grid-template-columns:1fr 1fr}
      .detail-grid{grid-template-columns:1fr}
      .sticky-cta{left:8px;right:8px;bottom:8px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>지원공고알리미</h1>

  <div class="openchat-wrap">
    <a class="openchat-btn" href="https://open.kakao.com/o/g8G5kWfi" target="_blank" rel="noopener noreferrer">카톡 오픈챗팅 바로가기</a>
  </div>

  <section class="stats">
    <div class="box">
      <div id="updatedAt" class="small">최근 업데이트: -</div>
      <div id="dataSource" class="small">데이터 출처: -</div>
      <div class="small">확장 소스: IRIS · SMTECH · e나라도움 · 이지비즈 · 중소벤처24 (연동 완료)</div>
    </div>
  </section>

  <section class="profile">
    <select id="p_region"><option value="all">내 지역</option><option>서울</option><option>경기</option><option>부산</option><option>전북</option><option>강원</option></select>
    <select id="p_stage"><option value="all">업력</option><option value="예비">예비창업</option><option value="초기">3년 미만</option><option value="도약">7년 미만</option></select>
    <select id="p_field"><option value="all">관심분야</option><option value="창업">창업</option><option value="수출">수출</option><option value="기술">기술</option><option value="금융">금융</option></select>
    <select id="p_goal"><option value="all">목표</option><option value="지원금">지원금</option><option value="판로">판로</option><option value="투자">투자</option></select>
    <button class="btn" onclick="saveProfile()">프로필 저장</button>
  </section>

  <section class="filters">
    <input id="q" placeholder="키워드 (예: 예비창업패키지, 수출, R&D)"/>
    <select id="source"><option value="all">전체 출처</option><option value="kstartup">K-Startup</option><option value="bizinfo">기업마당</option><option value="iris">IRIS(국가R&D)</option><option value="smtech">SMTECH</option><option value="gosims">e나라도움</option><option value="egbiz">이지비즈</option><option value="smes24">중소벤처24</option></select>
    <select id="region"><option value="all">지역 전체</option><option>서울</option><option>경기</option><option>부산</option><option>전북</option><option>강원</option></select>
    <select id="dd"><option value="all">마감 전체</option><option value="1">D-1</option><option value="3">D-3</option><option value="7">D-7</option></select>
    <select id="viewMode"><option value="all">전체 보기</option><option value="bookmarked">북마크만</option></select>
    <button class="btn" onclick="render()">적용</button>
  </section>

  <section class="quick-filters">
    <span class="small" style="padding:10px 4px">원클릭 필터:</span>
    <button class="btn-lite" onclick="applyPreset('smallbiz')">소상공인</button>
    <button class="btn-lite" onclick="applyPreset('prestartup')">예비창업</button>
    <button class="btn-lite" onclick="applyPreset('rnd')">R&D</button>
    <button class="btn-lite" onclick="applyPreset('fund')">시설자금</button>
    <button class="btn-lite" onclick="resetFilters()">초기화</button>
  </section>

  <section class="todo">
    <b>오늘의 실행 플랜</b>
    <ul id="todoList"></ul>
  </section>

  <section id="cards" class="cards"></section>
</div>

<div id="detailModal" class="modal" onclick="if(event.target.id==='detailModal') closeDetail()">
  <div class="modal-card">
    <div class="row" style="margin-bottom:6px">
      <b style="font-size:18px">공고 상세</b>
      <button class="btn-lite" onclick="closeDetail()">닫기</button>
    </div>
    <h2 id="detailTitle" style="font-size:20px;line-height:1.35;margin:8px 0 10px"></h2>
    <div class="reasons" id="detailTags"></div>
    <div class="detail-grid" style="margin-top:10px">
      <div class="detail-box"><b>지원대상</b><div id="detailTarget">-</div></div>
      <div class="detail-box"><b>지원내용</b><div id="detailBenefit">-</div></div>
      <div class="detail-box"><b>신청방법</b><div id="detailHow">-</div></div>
      <div class="detail-box"><b>제출서류(체크)</b><div id="detailDocs">-</div></div>
    </div>
    <div class="small" id="detailMeta" style="margin-top:10px"></div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <a id="detailUrl" class="btn" target="_blank" rel="noopener noreferrer" style="display:inline-block">원문 공고 바로가기</a>
      <a class="openchat-btn" href="https://open.kakao.com/o/g8G5kWfi" target="_blank" rel="noopener noreferrer">카톡 오픈챗팅 바로가기</a>
    </div>
  </div>
</div>

<div class="sticky-cta">
  <a href="https://open.kakao.com/o/g8G5kWfi" target="_blank" rel="noopener noreferrer">카톡 오픈챗팅 바로가기</a>
</div>

<script>
let RAW=[];
let LAST_RENDERED=[];
const PROFILE_KEY='support_notice_profile_v2';
const BOOKMARK_KEY='support_notice_bookmarks_v1';
let bookmarks=new Set();
let profile={region:'all',stage:'all',field:'all',goal:'all'};

function initData(){
  if(window.GOV_DATA && Array.isArray(window.GOV_DATA.notices)){
    RAW = window.GOV_DATA.notices;
    const updated = window.GOV_DATA.updatedAt || '-';
    document.getElementById('updatedAt').textContent = '최근 업데이트: ' + updated;
    const srcs = [...new Set((window.GOV_DATA.notices||[]).map(n=>n.source))];
    document.getElementById('dataSource').textContent = '데이터 출처: ' + (srcs.length ? srcs.join(' + ') : '-');
  } else {
    RAW = [];
    document.getElementById('dataSource').textContent = '데이터 출처: 로드 실패';
  }
}

function loadProfile(){
  try{ profile={...profile,...JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}')}; }catch(e){}
  ['region','stage','field','goal'].forEach(k=>{
    const el=document.getElementById('p_'+k);
    if(el) el.value=profile[k]||el.value;
  });
}

function saveProfile(){
  profile={
    region:document.getElementById('p_region').value,
    stage:document.getElementById('p_stage').value,
    field:document.getElementById('p_field').value,
    goal:document.getElementById('p_goal').value,
  };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
  render();
}

function loadBookmarks(){
  try{
    const arr=JSON.parse(localStorage.getItem(BOOKMARK_KEY)||'[]');
    bookmarks=new Set(Array.isArray(arr)?arr:[]);
  }catch(e){ bookmarks=new Set(); }
}

function saveBookmarks(){
  localStorage.setItem(BOOKMARK_KEY, JSON.stringify([...bookmarks]));
}

function noticeKey(n){ return n.id || n.url || `${n.source}-${n.title}`; }

function toggleBookmark(key){
  if(bookmarks.has(key)) bookmarks.delete(key); else bookmarks.add(key);
  saveBookmarks();
  render();
}

function applyPreset(type){
  const q=document.getElementById('q');
  const source=document.getElementById('source');
  const dd=document.getElementById('dd');
  if(type==='smallbiz'){ q.value='소상공인'; source.value='all'; dd.value='all'; }
  if(type==='prestartup'){ q.value='예비창업'; source.value='all'; dd.value='all'; }
  if(type==='rnd'){ q.value='r&d'; source.value='iris'; dd.value='all'; }
  if(type==='fund'){ q.value='자금'; source.value='all'; dd.value='7'; }
  render();
}

function resetFilters(){
  document.getElementById('q').value='';
  document.getElementById('source').value='all';
  document.getElementById('region').value='all';
  document.getElementById('dd').value='all';
  document.getElementById('viewMode').value='all';
  render();
}

function dtag(d){ if(d<=1)return 'd1'; if(d<=3)return 'd3'; if(d<=7)return 'd7'; return ''; }
function dlabel(d){ if(d==null)return '마감정보없음'; if(d<0)return '마감지남'; return `D-${d}`; }
function fitClass(v){ if(v>=80) return 'fit-hi'; if(v>=60) return 'fit-mid'; return 'fit-low'; }
function fitLabel(v){ if(v>=80) return '지금 신청'; if(v>=60) return '준비 후 신청'; return '보류'; }

function calcScore(n,q){
  const reasons=[];
  let s=0;
  const t=(n.title||'');
  const c=(n.category||'');

  if(typeof n.dday==='number'){
    if(n.dday<=1){s+=50; reasons.push('D-1 임박');}
    else if(n.dday<=3){s+=35; reasons.push('D-3 임박');}
    else if(n.dday<=7){s+=20; reasons.push('D-7 임박');}
  }

  if(q && (t.toLowerCase().includes(q) || c.toLowerCase().includes(q))){s+=20; reasons.push('검색 키워드 일치');}

  if(profile.region!=='all' && t.includes(profile.region)){s+=20; reasons.push('지역 일치');}

  if(profile.stage!=='all'){
    if(profile.stage==='예비' && /예비/.test(t)){s+=25; reasons.push('업력(예비) 일치');}
    if(profile.stage==='초기' && /초기|청년창업사관|창업성공패키지/.test(t)){s+=25; reasons.push('업력(초기) 일치');}
    if(profile.stage==='도약' && /도약|스케일|성장/.test(t)){s+=25; reasons.push('업력(도약) 일치');}
  }

  if(profile.field!=='all' && (t.includes(profile.field)||c.includes(profile.field))){s+=20; reasons.push('관심분야 일치');}

  if(profile.goal!=='all'){
    if(profile.goal==='지원금' && /지원|보전|자금|융자/.test(t)){s+=10; reasons.push('목표(지원금) 일치');}
    if(profile.goal==='판로' && /수출|내수|판로|전시|박람/.test(t)){s+=10; reasons.push('목표(판로) 일치');}
    if(profile.goal==='투자' && /투자|tips|팁스|ir/.test(t.toLowerCase())){s+=10; reasons.push('목표(투자) 일치');}
  }

  return {fit:Math.min(100,s), reasons:reasons.slice(0,3)};
}

function makeTodo(list){
  const top=list.filter(x=>x.fit>=60).slice(0,3);
  const todo=[];
  if(top[0]) todo.push(`1) ${top[0].title.slice(0,30)}... 자격요건/필수서류 먼저 확인`);
  if(top[1]) todo.push(`2) ${top[1].title.slice(0,30)}... 접수 마감 시간 전 제출 리허설`);
  todo.push('3) 맞춤점수 80점 이상 1건은 오늘 바로 신청 시작');
  return todo;
}

function inferTarget(n){
  const t=(n.title||'');
  if(/예비/.test(t)) return '예비창업자 중심 공고입니다.';
  if(/소상공인/.test(t)) return '소상공인/자영업자 대상 공고입니다.';
  if(/중소기업|중견/.test(t)) return '중소·중견기업 대상 공고입니다.';
  return '원문 공고의 신청자격(업력/매출/지역) 섹션 확인이 필요합니다.';
}

function inferBenefit(n){
  const t=(n.title||'');
  if(/자금|융자|보전|지원금/.test(t)) return '자금/보전 형태의 지원 가능성이 높습니다.';
  if(/수출|판로|전시|박람/.test(t)) return '수출·판로 개척 지원 성격 공고입니다.';
  if(/R&D|기술|개발|연구/i.test(t)) return 'R&D/기술개발 관련 지원 공고입니다.';
  return '사업화/교육/컨설팅/바우처 등 복합 지원 가능성이 있습니다.';
}

function inferHow(n){
  if(n.source==='kstartup') return 'K-Startup 원문에서 회원 로그인 후 신청합니다.';
  if(n.source==='bizinfo') return '기업마당 원문에서 접수 경로를 확인해 신청합니다.';
  if(n.source==='iris') return 'IRIS 시스템 공고 원문에서 신청절차를 확인합니다.';
  if(n.source==='smtech') return 'SMTECH 원문에서 온라인 접수 진행합니다.';
  if(n.source==='gosims') return 'e나라도움 원문에서 공모신청 절차를 따릅니다.';
  return '원문 공고의 신청방법/접수처를 확인해 온라인으로 진행합니다.';
}

function inferDocs(n){
  const docs=['사업계획서','사업자등록(또는 예정 증빙)','재무/매출 관련 증빙','가점 증빙(해당 시)'];
  if(/수출|해외/.test(n.title||'')) docs.push('수출실적/해외진출 계획서');
  if(/R&D|기술|개발/i.test(n.title||'')) docs.push('기술개발 계획서/인력현황');
  return docs.map(d=>`□ ${d}`).join('<br>');
}

function openDetail(encodedKey){
  const key=decodeURIComponent(encodedKey);
  const n=LAST_RENDERED.find(x=>x._key===key) || RAW.find(x=>noticeKey(x)===key);
  if(!n) return;

  document.getElementById('detailTitle').textContent=n.title||'-';
  document.getElementById('detailTags').innerHTML=`
    <span class="tag">${n.source||'-'}</span>
    <span class="tag ${dtag(n.dday)}">${dlabel(n.dday)}</span>
    <span class="tag ${fitClass(n.fit||0)}">맞춤점수 ${n.fit||0}</span>
  `;
  document.getElementById('detailTarget').textContent=n.target||inferTarget(n);
  document.getElementById('detailBenefit').textContent=n.benefit||inferBenefit(n);
  document.getElementById('detailHow').textContent=n.howToApply||inferHow(n);
  document.getElementById('detailDocs').innerHTML=n.documents||inferDocs(n);
  document.getElementById('detailMeta').textContent=`분류: ${n.category||'-'} · 기관: ${n.org||'-'} · 마감: ${n.deadline||'-'}`;
  document.getElementById('detailUrl').href=n.url||'#';
  document.getElementById('detailModal').classList.add('on');
}

function closeDetail(){
  document.getElementById('detailModal').classList.remove('on');
}

function render(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const s=document.getElementById('source').value;
  const d=document.getElementById('dd').value;
  const region=document.getElementById('region').value;
  const viewMode=document.getElementById('viewMode').value;

  let list=RAW.filter(n=>s==='all'||n.source===s)
    .filter(n=>typeof n.dday !== 'number' || n.dday >= 0)
    .filter(n=>(n.title||'').toLowerCase().includes(q))
    .filter(n=>region==='all'||(n.title||'').includes(region));

  if(d!=='all'){
    const lim=Number(d);
    list=list.filter(n=>typeof n.dday==='number' && n.dday>=0 && n.dday<=lim);
  }

  list=list.map(n=>{
    const sc=calcScore(n,q);
    const key=noticeKey(n);
    return {...n, _key:key, fit:sc.fit, reasons:sc.reasons, bookmarked: bookmarks.has(key)};
  });

  if(viewMode==='bookmarked') list=list.filter(n=>n.bookmarked);

  list.sort((a,b)=>b.fit-a.fit || ((a.dday??999)-(b.dday??999)));
  LAST_RENDERED=list;

  document.getElementById('todoList').innerHTML = makeTodo(list).map(x=>`<li>${x}</li>`).join('');

  document.getElementById('cards').innerHTML = list.slice(0,60).map(n=>`
    <article class="card">
      <div class="row">
        <span class="tag">${n.source}</span>
        <span class="tag ${dtag(n.dday)}">${dlabel(n.dday)}</span>
      </div>
      <h3 style="font-size:16px;line-height:1.4;margin:8px 0">${n.title}</h3>
      <div class="small">분류: ${n.category||'-'} · 마감: ${n.deadline||'-'}</div>
      <div class="reasons">${(n.reasons||[]).map(r=>`<span class='reason'>${r}</span>`).join('')}</div>
      <div class="row" style="margin-top:8px">
        <span class="tag ${fitClass(n.fit)}">맞춤점수 ${n.fit} · ${fitLabel(n.fit)}</span>
        <button class="btn-lite bookbtn ${n.bookmarked?'on':''}" onclick="toggleBookmark('${n._key.replace(/'/g,"\\'")}')">${n.bookmarked?'★ 북마크 해제':'☆ 북마크 저장'}</button>
      </div>
      <div class="row" style="margin-top:8px;align-items:flex-end">
        <span class="small">기관: ${n.org||'-'}</span>
        <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end">
          <button class="btn-lite bookbtn" onclick="openDetail('${encodeURIComponent(n._key)}')">상세 보기</button>
          <a href="${n.url}" target="_blank">원문 보기</a>
        </div>
      </div>
    </article>
  `).join('');
}

initData();
loadProfile();
loadBookmarks();
render();
</script>
</body>
</html>
