<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì§€ì›ê³µê³ ì•Œë¦¬ë¯¸ MVP</title>
  <script src="./notices.js?v=20260212-0059"></script>
  <style>
    :root{--bg:#f4f7fb;--card:#fff;--line:#dce4ee;--text:#1f2d3d;--sub:#62758b;--brand:#2d7ff9}
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo',sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{margin:0 0 4px;color:#16314f}
    .small{font-size:12px;color:var(--sub)}

    .stats,.profile,.filters,.todo,.cards{display:grid;gap:10px}
    .stats{grid-template-columns:1fr;margin-bottom:10px}
    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}

    .profile{grid-template-columns:repeat(4,1fr) auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    .filters{grid-template-columns:1.2fr .8fr .8fr .8fr .8fr auto;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px;margin-bottom:10px}
    input,select,button{padding:10px;border:1px solid #c8d5e4;border-radius:10px;background:#fff}
    button{cursor:pointer}.btn{background:var(--brand);color:#fff;border:none;font-weight:700}
    .btn-lite{background:#fff;color:#2f5b95;border:1px solid #cfe0f3;font-weight:700}
    .btn-lite.on{background:#eef4ff}

    .todo{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .todo ul{margin:8px 0 0 18px;padding:0}
    .bookbtn{font-size:12px;padding:6px 10px}

    .cards{grid-template-columns:repeat(auto-fill,minmax(330px,1fr));padding-bottom:80px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#eef4ff;border:1px solid #d2e1ff;color:#2f5b95;white-space:nowrap}
    .d1{background:#fff2f2;border-color:#ffcaca;color:#b42318}.d3{background:#fff8eb;border-color:#ffd9ab;color:#ad5b00}.d7{background:#f2fbf7;border-color:#c9efdf;color:#0a7a52}
    .fit-hi{background:#effcf6;border-color:#b8ebd4;color:#0a7a52}.fit-mid{background:#fff8eb;border-color:#ffd9ab;color:#ad5b00}.fit-low{background:#f4f7fb;border-color:#d7e1ed;color:#5f7186}
    .reasons{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .reason{font-size:11px;padding:2px 8px;border-radius:999px;background:#f7f9fd;border:1px solid #e1e8f2;color:#4f6479}
    a{color:#1b73e8;text-decoration:none;font-weight:600}
    .openchat-wrap{margin:0 0 10px;display:flex;gap:8px;flex-wrap:wrap}
    .openchat-btn{display:inline-block;background:#FEE500;color:#1f1f1f !important;border:1px solid #e8d200;padding:10px 14px;border-radius:10px;font-weight:800}
    .docshunt-btn{display:inline-block;background:var(--brand);color:#fff !important;border:1px solid #1f6fe7;padding:10px 14px;border-radius:10px;font-weight:800}
    .request-btn{display:inline-block;background:#334155;color:#fff !important;padding:10px 16px;border-radius:10px;font-weight:700;margin-bottom:15px;text-decoration:none}
    .request-btn:hover{background:#1e293b}

    @media (max-width:1050px){
      .stats{grid-template-columns:1fr 1fr}
      .profile{grid-template-columns:1fr 1fr 1fr}
      .filters{grid-template-columns:1fr 1fr}
    }
    @media (max-width:640px){
      .cards{grid-template-columns:1fr}
      .profile{grid-template-columns:1fr 1fr}
      .sticky-cta{left:8px;right:8px;bottom:8px}
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ì§€ì›ê³µê³ ì•Œë¦¬ë¯¸</h1>
  
  <a href="#" class="request-btn">ğŸ’¡ ì›í•˜ëŠ” ê¸°ëŠ¥ ìš”ì²­í•˜ê¸°</a>

  <section class="stats">
    <div class="box">
      <div id="updatedAt" class="small">ìµœê·¼ ì—…ë°ì´íŠ¸: -</div>
      <div id="dataSource" class="small">ë°ì´í„° ì¶œì²˜: -</div>
      <div id="opSource" class="small">ìš´ì˜ ì†ŒìŠ¤: -</div>
    </div>
  </section>

  <section class="profile">
    <select id="p_region"><option value="all">ë‚´ ì§€ì—­</option><option>ì„œìš¸</option><option>ê²½ê¸°</option><option>ë¶€ì‚°</option><option>ì „ë¶</option><option>ê°•ì›</option></select>
    <select id="p_stage"><option value="all">ì—…ë ¥</option><option value="ì˜ˆë¹„">ì˜ˆë¹„ì°½ì—…</option><option value="ì´ˆê¸°">3ë…„ ë¯¸ë§Œ</option><option value="ë„ì•½">7ë…„ ë¯¸ë§Œ</option></select>
    <select id="p_field"><option value="all">ê´€ì‹¬ë¶„ì•¼</option><option value="ì°½ì—…">ì°½ì—…</option><option value="ìˆ˜ì¶œ">ìˆ˜ì¶œ</option><option value="ê¸°ìˆ ">ê¸°ìˆ </option><option value="ê¸ˆìœµ">ê¸ˆìœµ</option></select>
    <select id="p_goal"><option value="all">ëª©í‘œ</option><option value="ì§€ì›ê¸ˆ">ì§€ì›ê¸ˆ</option><option value="íŒë¡œ">íŒë¡œ</option><option value="íˆ¬ì">íˆ¬ì</option></select>
    <button class="btn" onclick="saveProfile()">í”„ë¡œí•„ ì €ì¥</button>
  </section>

  <section class="filters">
    <input id="q" placeholder="í‚¤ì›Œë“œ (ì˜ˆ: ì˜ˆë¹„ì°½ì—…íŒ¨í‚¤ì§€, ìˆ˜ì¶œ, R&D)"/>
    <select id="source"><option value="all">ì „ì²´ ì¶œì²˜</option><option value="kstartup">K-Startup</option><option value="bizinfo">ê¸°ì—…ë§ˆë‹¹</option></select>
    <select id="region"><option value="all">ì§€ì—­ ì „ì²´</option><option>ì„œìš¸</option><option>ê²½ê¸°</option><option>ë¶€ì‚°</option><option>ì „ë¶</option><option>ê°•ì›</option></select>
    <select id="dd"><option value="all">ë§ˆê° ì „ì²´</option><option value="1">D-1</option><option value="3">D-3</option><option value="7">D-7</option></select>
    <select id="viewMode"><option value="all">ì „ì²´ ë³´ê¸°</option><option value="bookmarked">ë¶ë§ˆí¬ë§Œ</option></select>
    <button class="btn" onclick="render(); alert('ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');">ì ìš©</button>
  </section>

  <section class="todo">
    <b>ì˜¤ëŠ˜ì˜ ì‹¤í–‰ í”Œëœ</b>
    <ul id="todoList"></ul>
  </section>

  <section id="cards" class="cards"></section>
</div>

<script>
let RAW=[];
const PROFILE_KEY='support_notice_profile_v2';
const BOOKMARK_KEY='support_notice_bookmarks_v1';
let bookmarks=new Set();
let profile={region:'all',stage:'all',field:'all',goal:'all'};


const SOURCE_LABELS={
  kstartup:'K-Startup',
  bizinfo:'ê¸°ì—…ë§ˆë‹¹',
};
function sourceLabel(v){ return SOURCE_LABELS[v]||v||'-'; }

function initData(){
  if(window.GOV_DATA && Array.isArray(window.GOV_DATA.notices)){
    RAW = window.GOV_DATA.notices;
    const updated = window.GOV_DATA.updatedAt || '-';
    document.getElementById('updatedAt').textContent = 'ìµœê·¼ ì—…ë°ì´íŠ¸: ' + updated;
    const srcs = [...new Set((window.GOV_DATA.notices||[]).map(n=>n.source))];
    const srcLabel = (srcs.length ? srcs.map(sourceLabel).join(' + ') : '-');
    document.getElementById('dataSource').textContent = 'ë°ì´í„° ì¶œì²˜: ' + srcLabel;
    document.getElementById('opSource').textContent = 'ìš´ì˜ ì†ŒìŠ¤: ' + srcLabel;
  } else {
    RAW = [];
    document.getElementById('dataSource').textContent = 'ë°ì´í„° ì¶œì²˜: ë¡œë“œ ì‹¤íŒ¨';
  }
}

function loadProfile(){
  try{ profile={...profile,...JSON.parse(localStorage.getItem(PROFILE_KEY)||'{}')}; }catch(e){}
  ['region','stage','field','goal'].forEach(k=>{
    const el=document.getElementById('p_'+k);
    if(el) el.value=profile[k]||el.value;
  });
}

function saveProfile(){
  profile={
    region:document.getElementById('p_region').value,
    stage:document.getElementById('p_stage').value,
    field:document.getElementById('p_field').value,
    goal:document.getElementById('p_goal').value,
  };
  localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  render();
}

function loadBookmarks(){
  try{
    const arr=JSON.parse(localStorage.getItem(BOOKMARK_KEY)||'[]');
    bookmarks=new Set(Array.isArray(arr)?arr:[]);
  }catch(e){ bookmarks=new Set(); }
}

function saveBookmarks(){
  localStorage.setItem(BOOKMARK_KEY, JSON.stringify([...bookmarks]));
}

function noticeKey(n){ return n.id || n.url || `${sourceLabel(n.source)}-${n.title}`; }

function toggleBookmark(key){
  if(bookmarks.has(key)) bookmarks.delete(key); else bookmarks.add(key);
  saveBookmarks();
  render();
}

function dtag(d){ if(d<=1)return 'd1'; if(d<=3)return 'd3'; if(d<=7)return 'd7'; return ''; }
function dlabel(d){ if(d==null)return 'ë§ˆê°ì •ë³´ì—†ìŒ'; if(d<0)return 'ë§ˆê°ì§€ë‚¨'; return `D-${d}`; }
function fitClass(v){ if(v>=80) return 'fit-hi'; if(v>=60) return 'fit-mid'; return 'fit-low'; }
function fitLabel(v){ if(v>=80) return 'ì§€ê¸ˆ ì‹ ì²­'; if(v>=60) return 'ì¤€ë¹„ í›„ ì‹ ì²­'; return 'ë³´ë¥˜'; }
function extractDeadlineTime(n){
  const cand=[n.deadlineTime,n.deadlineText,n.period,n.title]
    .map(v=>(v||'').toString())
    .join(' | ');

  // 18:00 / 9:30
  let m=cand.match(/(?:^|\D)([01]?\d|2[0-3]):([0-5]\d)(?:\D|$)/);
  if(m) return `${m[1].padStart(2,'0')}:${m[2]}`;

  // 18ì‹œ 00ë¶„ / 18ì‹œ
  m=cand.match(/(?:^|\D)([01]?\d|2[0-3])\s*ì‹œ(?:\s*([0-5]?\d)\s*ë¶„)?/);
  if(m){
    const hh=m[1].padStart(2,'0');
    const mm=(m[2]||'00').padStart(2,'0');
    return `${hh}:${mm}`;
  }
  return '';
}

function deadlineWithTime(n){
  const d=(n.deadline||'').toString().trim();
  if(!d) return '-';
  const t=extractDeadlineTime(n);
  if(t) return `${d} ${t}`;
  return d;
}

function calcScore(n,q){
  const reasons=[];
  let s=0;
  const t=(n.title||'');
  const c=(n.category||'');

  if(typeof n.dday==='number'){
    if(n.dday<=1){s+=50; reasons.push('D-1 ì„ë°•');}
    else if(n.dday<=3){s+=35; reasons.push('D-3 ì„ë°•');}
    else if(n.dday<=7){s+=20; reasons.push('D-7 ì„ë°•');}
  }

  if(q && (t.toLowerCase().includes(q) || c.toLowerCase().includes(q))){s+=20; reasons.push('ê²€ìƒ‰ í‚¤ì›Œë“œ ì¼ì¹˜');}

  if(profile.region!=='all' && t.includes(profile.region)){s+=20; reasons.push('ì§€ì—­ ì¼ì¹˜');}

  if(profile.stage!=='all'){
    if(profile.stage==='ì˜ˆë¹„' && /ì˜ˆë¹„/.test(t)){s+=25; reasons.push('ì—…ë ¥(ì˜ˆë¹„) ì¼ì¹˜');}
    if(profile.stage==='ì´ˆê¸°' && /ì´ˆê¸°|ì²­ë…„ì°½ì—…ì‚¬ê´€|ì°½ì—…ì„±ê³µíŒ¨í‚¤ì§€/.test(t)){s+=25; reasons.push('ì—…ë ¥(ì´ˆê¸°) ì¼ì¹˜');}
    if(profile.stage==='ë„ì•½' && /ë„ì•½|ìŠ¤ì¼€ì¼|ì„±ì¥/.test(t)){s+=25; reasons.push('ì—…ë ¥(ë„ì•½) ì¼ì¹˜');}
  }

  if(profile.field!=='all' && (t.includes(profile.field)||c.includes(profile.field))){s+=20; reasons.push('ê´€ì‹¬ë¶„ì•¼ ì¼ì¹˜');}

  if(profile.goal!=='all'){
    if(profile.goal==='ì§€ì›ê¸ˆ' && /ì§€ì›|ë³´ì „|ìê¸ˆ|ìœµì/.test(t)){s+=10; reasons.push('ëª©í‘œ(ì§€ì›ê¸ˆ) ì¼ì¹˜');}
    if(profile.goal==='íŒë¡œ' && /ìˆ˜ì¶œ|ë‚´ìˆ˜|íŒë¡œ|ì „ì‹œ|ë°•ëŒ/.test(t)){s+=10; reasons.push('ëª©í‘œ(íŒë¡œ) ì¼ì¹˜');}
    if(profile.goal==='íˆ¬ì' && /íˆ¬ì|tips|íŒìŠ¤|ir/.test(t.toLowerCase())){s+=10; reasons.push('ëª©í‘œ(íˆ¬ì) ì¼ì¹˜');}
  }

  return {fit:Math.min(100,s), reasons:reasons.slice(0,3)};
}

function makeTodo(list){
  const top=list.filter(x=>x.fit>=60).slice(0,3);
  const todo=[];
  if(top[0]) todo.push(`1) ${top[0].title.slice(0,30)}... ìê²©ìš”ê±´/í•„ìˆ˜ì„œë¥˜ ë¨¼ì € í™•ì¸`);
  if(top[1]) todo.push(`2) ${top[1].title.slice(0,30)}... ì ‘ìˆ˜ ë§ˆê° ì‹œê°„ ì „ ì œì¶œ ë¦¬í—ˆì„¤`);
  todo.push('3) ë§ì¶¤ì ìˆ˜ 80ì  ì´ìƒ 1ê±´ì€ ì˜¤ëŠ˜ ë°”ë¡œ ì‹ ì²­ ì‹œì‘');
  return todo;
}

function render(){
  const q=document.getElementById('q').value.trim().toLowerCase();
  const s=document.getElementById('source').value;
  const d=document.getElementById('dd').value;
  const region=document.getElementById('region').value;
  const viewMode=document.getElementById('viewMode').value;

  let list=RAW.filter(n=>s==='all'||n.source===s)
    .filter(n=>typeof n.dday !== 'number' || n.dday >= 0)
    .filter(n=>(n.title||'').toLowerCase().includes(q))
    .filter(n=>region==='all'||(n.title||'').includes(region));

  if(d!=='all'){
    const lim=Number(d);
    list=list.filter(n=>typeof n.dday==='number' && n.dday>=0 && n.dday<=lim);
  }

  list=list.map(n=>{
    const sc=calcScore(n,q);
    const key=noticeKey(n);
    return {...n, _key:key, fit:sc.fit, reasons:sc.reasons, bookmarked: bookmarks.has(key)};
  });

  if(viewMode==='bookmarked') list=list.filter(n=>n.bookmarked);

  list.sort((a,b)=>b.fit-a.fit || ((a.dday??999)-(b.dday??999)));

  document.getElementById('todoList').innerHTML = makeTodo(list).map(x=>`<li>${x}</li>`).join('');

  document.getElementById('cards').innerHTML = list.slice(0,60).map(n=>`
    <article class="card">
      <div class="row">
        <span class="tag">${sourceLabel(n.source)}</span>
        <span class="tag ${dtag(n.dday)}">${dlabel(n.dday)}</span>
      </div>
      <h3 style="font-size:16px;line-height:1.4;margin:8px 0">${n.title}</h3>
      <div class="small">ë¶„ë¥˜: ${n.category||'-'} Â· ë§ˆê°: ${deadlineWithTime(n)}</div>
      <div class="small">ì§€ì›ê¸ˆ: ${n.supportAmount||'í™•ì¸ í•„ìš”'}</div>
      <div class="reasons">${(n.reasons||[]).map(r=>`<span class='reason'>${r}</span>`).join('')}</div>
      <div class="row" style="margin-top:8px">
        <span class="tag ${fitClass(n.fit)}">ë§ì¶¤ì ìˆ˜ ${n.fit} Â· ${fitLabel(n.fit)}</span>
        <button class="btn-lite bookbtn ${n.bookmarked?'on':''}" onclick="toggleBookmark('${n._key.replace(/'/g,"\\'")}')">${n.bookmarked?'â˜… ë¶ë§ˆí¬ í•´ì œ':'â˜† ë¶ë§ˆí¬ ì €ì¥'}</button>
      </div>
      <div class="row" style="margin-top:8px;justify-content:flex-end">
        <a href="${n.url}" target="_blank">ì›ë¬¸ ë³´ê¸°</a>
      </div>
    </article>
  `).join('');
}

initData();
loadProfile();
loadBookmarks();
render();
</script>
</body>
</html>
